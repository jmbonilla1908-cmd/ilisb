{% extends "webapps/base_aplicativo.html" %}

{% block aplicativo_content %}
<div class="card">
    <div class="card-header">
        <h4 class="mb-0">Calculadora de Curvas de Bomba vs. Sistema</h4>
    </div>
    <div class="card-body">
        <form id="curvas-form">
            <!-- Puntos de la Curva de la Bomba -->
            <fieldset class="mb-4">
                <legend class="h5">1. Puntos de la Curva de la Bomba</legend>
                <div id="puntos-bomba-container">
                    <!-- Los puntos se añadirán aquí dinámicamente -->
                </div>
                <button type="button" id="add-point-btn" class="btn btn-sm btn-outline-primary mt-2">
                    Añadir Punto
                </button>
            </fieldset>

            <!-- Datos de la Instalación -->
            <fieldset class="mb-4">
                <legend class="h5">2. Datos de la Instalación</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="altura_estatica" class="form-label">Altura Estática (Hk)</label>
                        <input type="number" class="form-control" id="altura_estatica" name="altura_estatica" step="0.01" required>
                    </div>
                </div>
            </fieldset>

            <!-- Punto de Operación Deseado -->
            <fieldset class="mb-4">
                <legend class="h5">3. Punto de Operación Deseado</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="q_operacion" class="form-label">Caudal (Q)</label>
                        <input type="number" class="form-control" id="q_operacion" name="q_operacion" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="h_operacion" class="form-label">Altura (H)</label>
                        <input type="number" class="form-control" id="h_operacion" name="h_operacion" step="0.01" required>
                    </div>
                </div>
            </fieldset>

            <button type="submit" class="btn btn-primary w-100">Calcular y Graficar</button>
        </form>

        <!-- Área para la gráfica -->
        <div id="grafico-container" class="mt-4" style="display: none;">
            <canvas id="curvasChart"></canvas>
        </div>
        <div id="error-container" class="alert alert-danger mt-4" style="display: none;"></div>
    </div>
</div>
{% endblock %}

{% block instrucciones_titulo %}
Curvas de Bomba
{% endblock %}

{% block instrucciones_content %}
<p>Esta herramienta te permite visualizar la curva de una bomba centrífuga y la curva de tu sistema para encontrar el punto de operación.</p>
<ol>
    <li>
        <strong>Puntos de la Curva de la Bomba:</strong> Ingresa al menos 3 puntos (Caudal y Altura) del catálogo del fabricante. La herramienta ajustará una curva a estos puntos.
    </li>
    <li>
        <strong>Datos de la Instalación:</strong> Proporciona la altura estática (Hk) de tu sistema. Esta es la diferencia de altura vertical que el fluido debe vencer, sin contar las pérdidas por fricción.
    </li>
    <li>
        <strong>Punto de Operación Deseado:</strong> Indica el caudal y la altura a los que esperas que el sistema trabaje. Esto se usará para calcular la curva del sistema.
    </li>
</ol>
<p class="fw-bold">Haz clic en "Calcular y Graficar" para ver los resultados.</p>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Chart.js para las gráficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('puntos-bomba-container');
    const addBtn = document.getElementById('add-point-btn');
    let pointCount = 0;

    function addPoint() {
        pointCount++;
        const div = document.createElement('div');
        div.classList.add('row', 'mb-2', 'align-items-center');
        div.innerHTML = `
            <div class="col-auto"><span class="fw-bold">Punto ${pointCount}:</span></div>
            <div class="col">
                <input type="number" class="form-control form-control-sm" placeholder="Caudal (Q)" name="q_bomba_${pointCount}" step="0.01" required>
            </div>
            <div class="col">
                <input type="number" class="form-control form-control-sm" placeholder="Altura (H)" name="h_bomba_${pointCount}" step="0.01" required>
            </div>
        `;
        container.appendChild(div);
    }

    // Añadir 3 puntos iniciales
    for (let i = 0; i < 3; i++) {
        addPoint();
    }

    addBtn.addEventListener('click', addPoint);

    // Lógica del formulario y la gráfica (simplificada, la lógica de cálculo está en el backend)
    const form = document.getElementById('curvas-form');
    const chartContainer = document.getElementById('grafico-container');
    const errorContainer = document.getElementById('error-container');
    let chart;

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        errorContainer.style.display = 'none';

        // Recolectar datos (esto es solo un ejemplo, la lógica completa está en tu JS)
        const puntos_bomba = [];
        for (let i = 1; i <= pointCount; i++) {
            const q = parseFloat(document.querySelector(`[name=q_bomba_${i}]`).value);
            const h = parseFloat(document.querySelector(`[name=h_bomba_${i}]`).value);
            if (!isNaN(q) && !isNaN(h)) {
                puntos_bomba.push({ q, h });
            }
        }
        
        const formData = {
            puntos_bomba: puntos_bomba,
            datos_instalacion: {
                altura_estatica: parseFloat(document.getElementById('altura_estatica').value)
            },
            punto_operacion: {
                q: parseFloat(document.getElementById('q_operacion').value),
                h: parseFloat(document.getElementById('h_operacion').value)
            }
        };

        // Aquí iría tu llamada fetch al endpoint /api/calcular-curvas
        // y la lógica para renderizar el gráfico con Chart.js
        alert('Formulario listo para enviar datos al backend. La lógica de fetch y Chart.js debe ser implementada.');
    });
});
</script>
{% endblock %}