<!-- Usamos la plantilla base de las webapps que ya tienes -->
{% extends "webapps/base_aplicativo.html" %}

{% block title %}Calculadora de Curva de Bomba{% endblock %}

{% block aplicativo_content %}
    <!-- 
      Este es el contenedor que HTMX actualizará.
      Lo llenamos inicialmente con el gráfico que pasamos desde la ruta principal.
    -->
    <div id="grafico-container">
        {{ graph_html|safe }}
    </div>

    <!-- Nuevo: Formulario para la Curva del Sistema -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Curva del Sistema</h5>
        </div>
        <div class="card-body">
            <p class="card-text">Defina los parámetros de su instalación para calcular y visualizar la curva del sistema y encontrar el punto de operación real.</p>
            <!-- Este formulario se integra con el de la derecha al usar el mismo método GET -->
            <form action="" method="GET">
                <div class="row">
                    <div class="col-md-4">
                        <label for="altura_estatica" class="form-label">Altura Estática (m)</label>
                        <input type="number" step="0.1" class="form-control" id="altura_estatica" name="altura_estatica" value="{{ request.args.get('altura_estatica', 15.0) }}">
                    </div>
                    <div class="col-md-4">
                        <label for="q_operacion" class="form-label">Caudal de Operación (m³/h)</label>
                        <input type="number" step="0.1" class="form-control" id="q_operacion" name="q_operacion" value="{{ request.args.get('q_operacion', 40.0) }}">
                    </div>
                    <div class="col-md-4">
                        <label for="h_operacion" class="form-label">Altura de Operación (m)</label>
                        <input type="number" step="0.1" class="form-control" id="h_operacion" name="h_operacion" value="{{ request.args.get('h_operacion', 35.0) }}">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-secondary">Calcular y Graficar Curva del Sistema</button>
                </div>
            </form>

            <!-- NUEVO: Sección de explicación dinámica -->
            {% if explicacion_sistema or explicacion_bep %}
            <div class="alert alert-light border mt-4" role="alert">
                <h5 class="alert-heading">Análisis del Sistema</h5>
                {% if explicacion_sistema %}
                <p>
                    Con los parámetros proporcionados, se ha determinado la ecuación de la curva de su sistema:
                </p>
                <p class="text-center fs-5 font-monospace">
                    {{ explicacion_sistema.ecuacion }}
                </p>
                <p class="mb-0 small">Donde el coeficiente de resistencia del sistema <strong>K = {{ explicacion_sistema.k_valor }}</strong> representa la suma de todas las pérdidas por fricción en la tubería, válvulas y accesorios. Un valor de K más alto indica mayores pérdidas.</p>
                <hr>
                {% endif %}
                {% if explicacion_bep %}
                <p class="mb-0">El <strong>Punto de Mejor Eficiencia (BEP)</strong> seleccionado al <strong>{{ explicacion_bep.eficiencia }}</strong> corresponde a un caudal de operación ideal de <strong>{{ explicacion_bep.caudal_bep }}</strong>. Compare este valor con el punto de operación real (intersección de curvas) para evaluar la selección de la bomba.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block instrucciones_titulo %}
    Calculadora Interactiva
{% endblock %}

{% block instrucciones_content %}
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Fundamento Técnico</h5>
        <p class="card-text">
          La <strong>Curva Característica (H-Q)</strong> de una bomba centrífuga representa la altura manométrica (H) que la bomba puede generar para un determinado caudal (Q). Esta curva es intrínseca al diseño de la bomba (geometría del impulsor, velocidad de rotación, etc.).
        </p>
        <p class="card-text">
          El <strong>Punto de Mejor Eficiencia</strong> (best efficiency point, <strong>BEP</strong>) es el punto en la curva H-Q donde la bomba opera con su máxima eficiencia hidráulica. Operar cerca del BEP es crucial para minimizar el consumo de energía, reducir el desgaste y evitar problemas como la cavitación o la recirculación.
        </p>
        <p class="card-text">
          Esta herramienta le permite visualizar cómo un punto de operación, definido por un porcentaje del caudal máximo, se relaciona con la curva de la bomba.
        </p>
      </div>
    </div>
    
    <form action="" method="GET" id="control-form" class="card card-body">
        <h5 class="card-title">Parámetros</h5>
        
        <div class="mb-3">
            <label for="eficiencia" class="form-label">Eficiencia de la Bomba (%)</label>
            <!-- onchange="this.form.submit()" es el mecanismo más simple para enviar el formulario sin JS -->
            <input type="range" class="form-range" min="1" max="100" id="eficiencia" 
                   name="eficiencia" value="{{ request.args.get('eficiencia', 75) }}"
                   onchange="this.form.submit()">
            <div class="text-center fw-bold">
                <span>{{ request.args.get('eficiencia', 75) }}</span>%
            </div>
        </div>

    </form>
{% endblock %}
